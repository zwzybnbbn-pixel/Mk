<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
/* === Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø© === */
*{
  font-family:'Cairo', sans-serif;
  box-sizing:border-box;
}

body{
body{
  background:#f2f7f7;
  margin:0;
  padding:0;   /* ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
  color:#222;
}

.container{
  width:100%;          /* ğŸ”¥ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ§Ø®Ø° Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„ ÙƒØ§Ù…Ù„ */
  max-width:100%;      /* ğŸ”¥ Ù…Ù†Ø¹ Ø§Ù„ØªØ¶ÙŠÙŠÙ‚ */
  padding:10px;        /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© ÙÙ‚Ø· */
  margin:0;            /* ğŸ”¥ Ù…Ù†Ø¹ ØªÙ…Ø±ÙƒØ² Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„ÙˆØ³Ø· */
}

/* === Ø§Ù„ÙƒØ±ÙˆØª â€” Ù†ÙØ³ ØªØµÙ…ÙŠÙ… doctors === */
.card{
  background:#ffffff;
  padding:18px;
  margin-bottom:15px;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,0.06);
}

/* === Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ù„ doctors === */
h1{
  text-align:center;
  font-size:22px;
  margin-bottom:10px;
  color:#006d63;
  font-weight:800;
}

/* === Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙØ§ØµÙŠÙ„ === */
.item{
  background:#f9ffff;
  border-left:4px solid #00a899;
  padding:10px;
  border-radius:10px;
  margin-bottom:10px;
}

.label{
  font-weight:700;
  color:#00534b;
  font-size:14.5px;
  margin-bottom:5px;
}

.value{
  color:#333;
  font-size:15px;
}

/* === Ø§Ù„Ø®Ø±ÙŠØ·Ø© === */
.map-wrap{
  margin-top:12px;
  border-radius:12px;
  overflow:hidden;
}

.map-wrap iframe{
  width:100%;
  height:240px;
  border:0;
}

/* === Ø§Ù„ØªÙ‚ÙŠÙŠÙ… === */
.rating-summary{
  display:flex;
  align-items:center;
  gap:12px;
}

.avg{
  color:#ffb300;
  font-size:32px;
  font-weight:900;
}

.meta{
  color:#555;
  font-size:13px;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„Ù†Ø¬ÙˆÙ… */
#ratingBar span{
  font-size:22px;
  color:#ffb300;
}

/* === Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª === */
.reviews{
  margin-top:10px;
}

.review{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:12px;
  box-shadow:0 2px 10px rgba(0,0,0,0.03);
}

.review .stars{
  color:#ffb300;
  font-size:16px;
  margin-bottom:5px;
}

.review .text{
  font-size:14px;
  color:#333;
  margin-bottom:6px;
}

.review .meta{
  font-size:12px;
  color:#555;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* Ø²Ø± Ø§Ù„Ø§Ø¹Ø¬Ø§Ø¨ */
.like-btn{
  background:#eee;
  border:0;
  padding:5px 10px;
  border-radius:8px;
  cursor:pointer;
}

.like-btn.liked{
  background:#ffe9b8;
}

.like-btn.disabled{
  pointer-events:none;
  opacity:0.7;
}

/* ÙƒØªØ§Ø¨Ø© ØªÙ‚ÙŠÙŠÙ… */
.add-box textarea{
  width:100%;
  min-height:100px;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
}

.stars-input{
  font-size:28px;
  cursor:pointer;
  color:#ccc;
  margin-bottom:5px;
}

.stars-input .active{
  color:#ffb300;
}

/* Ø§Ù„Ø²Ø± */
.btn{
  background:#009688;
  color:white;
  padding:10px 15px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  font-size:15px;
}

.back{
  margin-right:auto;
  text-decoration:none;
  color:#006d63;
  font-weight:700;
}
</style>
</head>

<body>

<div class="container">

  <div class="card">
    <h1 id="title">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
    <div id="detailsArea"></div>
    <div class="map-wrap" id="mapWrap" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="rating-summary">
      <div>
        <div class="avg" id="avgRating">0.0</div>
        <div class="meta" id="avgMeta">0 ØªÙ‚ÙŠÙŠÙ…</div>
      </div>
      <div id="ratingBar" style="margin-left:auto;"></div>
    </div>

    <div class="reviews" id="reviewsList"></div>
  </div>

  <div class="card add-box">
    <h3>Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

    <div id="starsInput" class="stars-input"></div>

    <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>

    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
      <button id="sendReview" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      <a href="hospitals.html" class="back">â† Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
    </div>
  </div>

</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  doc, getDoc,
  collection, addDoc, getDocs,
  query, orderBy, serverTimestamp,
  updateDoc, increment
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const id = new URLSearchParams(location.search).get("id");
if(!id){
  alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰.");
  location.href = "hospitals.html";
}

const titleEl = document.getElementById("title");
const detailsArea = document.getElementById("detailsArea");
const mapWrap = document.getElementById("mapWrap");
const avgRatingEl = document.getElementById("avgRating");
const avgMetaEl = document.getElementById("avgMeta");
const ratingBar = document.getElementById("ratingBar");
const reviewsList = document.getElementById("reviewsList");

const starsInput = document.getElementById("starsInput");
const reviewText = document.getElementById("reviewText");
const sendReview = document.getElementById("sendReview");

let selectedRating = 5;

/* Ù†Ø¬ÙˆÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
function renderStarsInput(){
  let html = "";
  for(let i=1;i<=5;i++){
    html += `<span data-rate="${i}" class="${i<=selectedRating ? 'active':''}">â˜…</span>`;
  }
  starsInput.innerHTML = html;
}
renderStarsInput();

starsInput.addEventListener("click", e=>{
  const s = e.target.closest("span[data-rate]");
  if(!s) return;
  selectedRating = Number(s.dataset.rate);
  renderStarsInput();
});

/* ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ */
async function loadHospital(){
  const ref = doc(db,"hospitals",id);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    titleEl.textContent = "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    return;
  }

  const h = snap.data();
  titleEl.textContent = h.name;

  detailsArea.innerHTML = `
    <div class="item"><div class="label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div class="value">${escapeHtml(h.city||"")}</div></div>
    <div class="item"><div class="label">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div><div class="value">${escapeHtml(h.departments||"")}</div></div>
    <div class="item"><div class="label">Ø§Ù„Ù‡Ø§ØªÙ</div><div class="value">${escapeHtml(h.phone||"")}</div></div>
    <div class="item"><div class="label">Ø§Ù„ÙˆØµÙ</div><div class="value">${escapeHtml(h.description||"Ù„Ø§ ÙŠÙˆØ¬Ø¯")}</div></div>
  `;

  if(h.locationLink){
    mapWrap.style.display="block";
    mapWrap.innerHTML = `<iframe src="${h.locationLink}" loading="lazy"></iframe>`;
  }
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª */
async function loadReviews(){
  const ref = collection(db,"hospitals",id,"reviews");
  const q = query(ref, orderBy("date","desc"));
  const snap = await getDocs(q);

  let reviews = [];
  let sum = 0;

  snap.forEach(d=>{
    reviews.push({ id:d.id, ...d.data() });
    sum += d.data().rating;
  });

  const count = reviews.length;
  avgRatingEl.textContent = count ? (sum/count).toFixed(1) : "0.0";
  avgMetaEl.textContent = `${count} ØªÙ‚ÙŠÙŠÙ…`;

  renderStarsBar(sum/count);

  reviewsList.innerHTML = "";

  if(count===0){
    reviewsList.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</p>";
    return;
  }

  const liked = JSON.parse(localStorage.getItem("liked_reviews_"+id)||"[]");

  reviews.forEach(r=>{
    const starStr = "â˜…".repeat(r.rating) + "â˜†".repeat(5-r.rating);
    const dateStr = r.date?.toDate?.() ? new Date(r.date.toDate()).toLocaleString() : "";

    const isLiked = liked.includes(r.id);

    const div = document.createElement("div");
    div.className="review";
    div.innerHTML = `
      <div class="stars">${starStr}</div>
      <div class="text">${escapeHtml(r.text)}</div>
      <div class="meta">
        <span>${dateStr}</span>
        <button class="like-btn ${isLiked?'liked disabled':''}" data-id="${r.id}">
          â¤ <span class="likes-count">${r.likes||0}</span>
        </button>
      </div>
    `;
    reviewsList.appendChild(div);
  });

  reviewsList.querySelectorAll(".like-btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const rid = btn.dataset.id;
      let liked = JSON.parse(localStorage.getItem("liked_reviews_"+id)||"[]");

      if(liked.includes(rid)) return;

      liked.push(rid);
      localStorage.setItem("liked_reviews_"+id, JSON.stringify(liked));

      await updateDoc(doc(db,"hospitals",id,"reviews",rid), {
        likes: increment(1)
      });

      btn.classList.add("liked","disabled");
      btn.querySelector(".likes-count").textContent++;
    });
  });
}

function renderStarsBar(avg){
  avg = Math.round(avg||0);
  let html = "";
  for(let i=1;i<=5;i++){
    html += i<=avg ? "â˜…" : "â˜†";
  }
  ratingBar.innerHTML = `<span>${html}</span>`;
}

/* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
sendReview.addEventListener("click", async ()=>{
  const text = reviewText.value.trim();
  if(!text) return alert("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹");

  await addDoc(collection(db,"hospitals",id,"reviews"),{
    rating:selectedRating,
    text,
    date:serverTimestamp(),
    likes:0
  });

  reviewText.value="";
  selectedRating=5;
  renderStarsInput();
  loadReviews();
});

/* Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù†Øµ */
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* ØªØ´ØºÙŠÙ„ */
loadHospital();
loadReviews();
</script>

</body>
</html>

