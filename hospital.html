<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
* {
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Cairo';
}

body {
  background:#eef3f3;
  padding:12px;
}

/* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
.back-btn{
  display:inline-block;
  background:#444;
  color:#fff;
  padding:10px 16px;
  border-radius:10px;
  text-decoration:none;
  margin-bottom:15px;
  font-size:16px;
}

/* Ø§Ù„ÙƒØ±ÙˆØª */
.card{
  width:100%;
  background:white;
  padding:18px;
  border-radius:15px;
  box-shadow:0 3px 12px #00000022;
  margin-bottom:15px;
}

h2{
  font-size:22px;
  color:#00695C;
  text-align:center;
  margin-bottom:15px;
  font-weight:800;
}

.info{
  background:#f9ffff;
  padding:12px;
  border-left:5px solid #00796B;
  border-radius:12px;
  margin-bottom:12px;
}

.label{
  font-size:15px;
  font-weight:700;
  color:#00695C;
}

.value{
  font-size:16px;
  color:#333;
  margin-top:4px;
}

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
.map-box iframe{
  width:100%;
  height:230px;
  border:0;
  border-radius:12px;
  margin-top:10px;
}

/* Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
.avg-box{
  text-align:center;
  margin-bottom:10px;
}

.avg-rating{
  font-size:40px;
  font-weight:900;
  color:#ffb300;
}

.rating-stars{
  font-size:22px;
  color:#ffb300;
}

.reviews .review{
  background:#fff;
  padding:12px;
  border-radius:12px;
  margin-bottom:12px;
  box-shadow:0 2px 10px #00000015;
}

.review .stars{
  color:#ffb300;
  font-size:18px;
}

.review p {
  margin:8px 0;
}

/* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ */
.like-btn{
  background:#eee;
  border:0;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  color:#333;
  font-size:14px;
}

.like-btn.liked{
  background:#ffdca0;
  color:#a65b00;
}

/* ÙƒØªØ§Ø¨Ø© ØªÙ‚ÙŠÙŠÙ… */
.add-review textarea{
  width:100%;
  min-height:100px;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
}

.stars-input span{
  font-size:30px;
  color:#ccc;
  cursor:pointer;
}

.stars-input .active{
  color:#ffb300;
}

.btn{
  background:#009688;
  color:white;
  padding:10px;
  border:0;
  border-radius:10px;
  font-size:16px;
  cursor:pointer;
  margin-top:10px;
}
</style>
</head>

<body>

<a href="hospitals.html" class="back-btn">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø©</a>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ -->
<div class="card">
  <h2 id="name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</div>
    <div class="value" id="city"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ:</div>
    <div class="value" id="phone"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ§© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</div>
    <div class="value" id="departments"></div>
  </div>

  <div class="info">
    <div class="label">ğŸ“ Ø§Ù„ÙˆØµÙ:</div>
    <div class="value" id="description"></div>
  </div>

  <div class="map-box" id="mapBox" style="display:none;"></div>
</div>

<!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… -->
<div class="card">
  <div class="avg-box">
    <div class="avg-rating" id="avgRating">0.0</div>
    <div class="rating-stars" id="ratingStars">â˜…â˜…â˜…â˜…â˜…</div>
    <div id="ratingCount">0 ØªÙ‚ÙŠÙŠÙ…</div>
  </div>

  <div class="reviews" id="reviewsList">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.</div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… -->
<div class="card add-review">
  <h3>Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>

  <div id="starsInput" class="stars-input"></div>

  <textarea id="reviewText" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>

  <button id="sendReview" class="btn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
</div>

<script type="module">
import { db } from "./firebase-config.js";
import {
  doc, getDoc,
  collection, addDoc, getDocs,
  query, orderBy, serverTimestamp,
  updateDoc, increment
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const id = new URLSearchParams(location.search).get("id");

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ */
async function loadHospital(){
  const snap = await getDoc(doc(db, "hospitals", id));
  if(!snap.exists()) return;

  const h = snap.data();
  name.textContent = h.name;
  city.textContent = h.city || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  phone.textContent = h.phone || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  departments.textContent = h.departments || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  description.textContent = h.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ";

  if(h.locationLink){
    mapBox.style.display="block";
    mapBox.innerHTML = `<iframe src="${h.locationLink}"></iframe>`;
  }
}

/* Ù†Ø¬ÙˆÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
let selected = 5;
function drawStarsInput(){
  starsInput.innerHTML = "";
  for(let i=1;i<=5;i++){
    starsInput.innerHTML += `<span data-id="${i}" class="${i<=selected?'active':''}">â˜…</span>`;
  }
}
drawStarsInput();

starsInput.addEventListener("click", e=>{
  const s = e.target.closest("span");
  if(!s) return;
  selected = Number(s.dataset.id);
  drawStarsInput();
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª + Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ */
async function loadReviews(){
  const q = query(
    collection(db,"hospitals",id,"reviews"),
    orderBy("date","desc")
  );

  const snap = await getDocs(q);

  let sum = 0;
  let count = 0;
  let html = "";

  const likedList = JSON.parse(localStorage.getItem("liked_reviews_"+id) || "[]");

  snap.forEach(r=>{
    const data = r.data();
    count++;
    sum += data.rating;

    const rId = r.id;
    const isLiked = likedList.includes(rId);
    const likes = data.likes || 0;

    html += `
      <div class="review">
        <div class="stars">${"â˜…".repeat(data.rating)}${"â˜†".repeat(5-data.rating)}</div>
        <p>${data.text}</p>

        <button class="like-btn ${isLiked?'liked':''}" data-id="${rId}">
          â¤ <span class="count">${likes}</span>
        </button>
      </div>
    `;
  });

  avgRating.textContent = count ? (sum/count).toFixed(1) : "0.0";
  ratingCount.textContent = count + " ØªÙ‚ÙŠÙŠÙ…";
  ratingStars.textContent = "â˜…".repeat(Math.round(sum/count)) + "â˜†".repeat(5-Math.round(sum/count));

  reviewsList.innerHTML = html || "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯.";

  /* ØªØ´ØºÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ */
  document.querySelectorAll(".like-btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const rId = btn.dataset.id;

      let liked = JSON.parse(localStorage.getItem("liked_reviews_"+id) || "[]");
      if(liked.includes(rId)) return;

      liked.push(rId);
      localStorage.setItem("liked_reviews_"+id, JSON.stringify(liked));

      btn.classList.add("liked");

      const countEl = btn.querySelector(".count");
      countEl.textContent = Number(countEl.textContent) + 1;

      await updateDoc(doc(db,"hospitals",id,"reviews",rId),{
        likes: increment(1)
      });
    });
  });
}

/* Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… */
sendReview.addEventListener("click", async ()=>{
  const text = reviewText.value.trim();
  if(!text) return alert("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚");

  await addDoc(collection(db,"hospitals",id,"reviews"),{
    rating:selected,
    text,
    likes:0,
    date:serverTimestamp()
  });

  reviewText.value = "";
  selected = 5;
  drawStarsInput();
  loadReviews();
});

/* ØªØ´ØºÙŠÙ„ */
loadHospital();
loadReviews();
</script>

</body>
</html>
